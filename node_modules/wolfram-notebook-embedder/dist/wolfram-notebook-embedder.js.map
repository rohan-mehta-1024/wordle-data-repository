{"version":3,"file":"wolfram-notebook-embedder.js","sources":["../src/main.js"],"sourcesContent":["const installedScripts = {};\nconst libraryLoading = {};\nlet counter = 0;\nlet isStyleInsertionPatched = false;\nconst insertedStyles = [];\nconst styleInsertionCallbacks = [];\n\nfunction installScript(url) {\n    if (!installedScripts[url]) {\n        const script = document.createElement('script');\n        script.type = 'text/javascript';\n        script.src = url;\n        const head = document.getElementsByTagName('head')[0];\n        head.appendChild(script);\n        installedScripts[url] = true;\n    }\n}\n\nfunction loadLibrary(libraryURL) {\n    if (!libraryLoading[libraryURL]) {\n        libraryLoading[libraryURL] = new Promise((resolve, reject) => {\n            const script = document.createElement('script');\n            script.type = 'text/javascript';\n            script.onerror = reject;\n            let callbackName;\n            do {\n                callbackName = '_wolframNotebookEmbedderCallback' + (++counter);\n            } while (window[callbackName]);\n            window[callbackName] = (lib) => {\n                delete window[callbackName];\n                resolve(lib);\n            };\n            script.src = libraryURL + '?callback=' + callbackName;\n            const head = document.getElementsByTagName('head')[0];\n            head.appendChild(script);\n        });\n    }\n    return libraryLoading[libraryURL];\n}\n\n/**\n * Splits a string into two parts at the first occurrence of any of the given separators.\n * @param s String to split.\n * @param separators Array of separators. Whichever separator occurs first in the string\n * is where the split happens.\n * @returns The part before the separator and the part after it.\n * If no separator occurs in the string, `[null, null]` is returned.\n */\nfunction split(s, separators) {\n    let before = null;\n    let after = null;\n    for (let i = 0; i < separators.length; ++i) {\n        const sep = separators[i];\n        const index = s.indexOf(sep);\n        if (index >= 0 && (before === null || index < before.length)) {\n            before = s.substring(0, index);\n            after = s.substring(index + sep.length);\n        }\n    }\n    return [before, after];\n}\n\nfunction isNotebookStyleElement(element, domains) {\n    const name = element.tagName.toLowerCase();\n    if (name === 'link' && (element.rel === 'stylesheet' || element.type === 'text/css')) {\n        return domains.some(domain => element.href.startsWith(domain));\n    } else if (name === 'style') {\n        if (element.dataset.isWolframNotebookStyle || element.innerText.indexOf('._ccc') >= 0) {\n            return true;\n        }\n        if (element.id === 'erd_scroll_detection_scrollbar_style') {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction patchShadowStyleInsertion(container, domains) {\n    function callback(element, allowMove) {\n        // When inserting the style element for the first time, use the original element,\n        // to make sure that onload and onerror handlers are preserved.\n        // For subsequent insertions (second embedded notebook and beyond), clone the element.\n        const styleElement = allowMove && !element.didInsertWithoutCloning ? element : element.cloneNode(true);\n        element.didInsertWithoutCloning = true;\n        container.appendChild(styleElement);\n    }\n\n    function handleStyleElement(element, allowMove) {\n        if (isNotebookStyleElement(element, domains)) {\n            insertedStyles.push(element);\n            styleInsertionCallbacks.forEach(cb => {\n                cb(element, allowMove);\n            });\n            return true;\n        }\n        return false;\n    }\n\n    if (!isStyleInsertionPatched) {\n        // There might be notebook-related <link> or <style> elements on the page already,\n        // e.g. when static HTML is already included on the page.\n        // These elements are not even necessarily in the document's <head>,\n        // but the notebook JS code will still not insert them again,\n        // so it's important we look for them anywhere in the document.\n        const existingLinks = document.getElementsByTagName('link');\n        for (let i = 0; i < existingLinks.length; ++i) {\n            handleStyleElement(existingLinks[i], false);\n        }\n        const existingStyles = document.getElementsByTagName('style');\n        for (let i = 0; i < existingStyles.length; ++i) {\n            handleStyleElement(existingStyles[i], false);\n        }\n        const head = document.getElementsByTagName('head')[0];\n        if (head) {\n            const originalAppendChild = head.appendChild;\n            head.appendChild = function (child) {\n                if (!handleStyleElement(child, true)) {\n                    originalAppendChild.call(this, child);\n                }\n            };\n        }\n        isStyleInsertionPatched = true;\n    }\n\n    insertedStyles.forEach(existingStyle => {\n        callback(existingStyle, false);\n    });\n    styleInsertionCallbacks.push(callback);\n    const index = styleInsertionCallbacks.length - 1;\n    return () => {\n        styleInsertionCallbacks.splice(index, 1);\n    };\n}\n\nfunction getNotebookData(source) {\n    let cloudBase = null;\n    let params = '';\n    let usePost = false;\n    let notebookExpr = null;\n    const notebookSource = {};\n    if (typeof source === 'string') {\n        const [domain, remainingPaths] = split(source, ['/obj/', '/objects/']);\n        if (!domain || !remainingPaths) {\n            throw new Error('InvalidCloudObjectURL');\n        }\n        cloudBase = domain;\n        // For now the query string is simply pruned.\n        const path = remainingPaths.split('?', 1)[0];\n        if (!path) {\n            throw new Error('InvalidCloudObjectURL');\n        }\n        params = 'path=' + encodeURIComponent(path);\n    } else if (source && typeof source === 'object') {\n        cloudBase = source.cloudBase || 'https://www.wolframcloud.com';\n        notebookSource.cloudBase = cloudBase;\n        const hasPath = typeof source.path !== 'undefined'\n        const hasExpr = typeof source.expr !== 'undefined';\n        const hasURL = typeof source.url !== 'undefined';\n        const paramCount = (hasPath ? 1 : 0) + (hasExpr ? 1 : 0) + (hasURL ? 1 : 0);\n        if (paramCount !== 1) {\n            throw new Error('InvalidSourceParameters');\n        }\n\n        if (hasPath) {\n            params = 'path=' + encodeURIComponent(source.path);\n            notebookSource.path = source.path;\n        } else if (hasURL) {\n            params = 'url=' + encodeURIComponent(source.url);\n            notebookSource.url = source.url;\n        } else if (hasExpr) {\n            notebookExpr = source.expr;\n            params = 'expr=' + encodeURIComponent(source.expr);\n            usePost = true;\n            notebookSource.expr = source.expr;\n        }\n    }\n    if (!cloudBase) {\n        throw new Error('InvalidSource');\n    }\n    if (cloudBase.charAt(cloudBase.length - 1) === '/') {\n        // Remove trailing '/' from the cloud base, as a courtesy.\n        cloudBase = cloudBase.substring(0, cloudBase.length - 1);\n    }\n    let embeddingAPI = cloudBase + '/notebooks/embedding';\n    if (!usePost) {\n        embeddingAPI += '?' + params;\n    }\n    return new Promise((resolve, reject) => {\n        // Use XMLHttpRequest instead of fetch to be compatible with older browsers.\n        const req = new XMLHttpRequest();\n        req.addEventListener('load', () => {\n            if (req.status === 200) {\n                const text = req.responseText;\n                const data = JSON.parse(text);\n                let extraData = data.extraData || [];\n                extraData.notebookSource = notebookSource;\n                resolve({\n                    notebookID: data.notebookID,\n                    mainScript: cloudBase + data.mainScript,\n                    otherScripts: (data.otherScripts || []).map(script => cloudBase + script),\n                    stylesheetDomains: [cloudBase, ...data.stylesheetDomains],\n                    notebookExpr: notebookExpr,\n\n                    // Extra data sent by the server in response to the initial request\n                    // to /notebooks/embedding, which we just pass through to the `.embed`\n                    // call. Could contain data such as a token for load balancing or\n                    // to maintain a session.\n                    extraData: extraData\n                });\n            } else {\n                reject(new Error('ResolveError'));\n            }\n        });\n        req.addEventListener('error', () => {\n            reject(new Error('RequestError'));\n        });\n        req.addEventListener('abort', () => {\n            reject(new Error('RequestAborted'));\n        });\n        if (usePost) {\n            req.open('POST', embeddingAPI, true);\n            req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n        } else {\n            req.open('GET', embeddingAPI, true);\n        }\n        if (usePost) {\n            req.send(params);\n        } else {\n            req.send();\n        }\n    });\n}\n\nfunction defaultValue(value, fallback) {\n    if (value === undefined) {\n        return fallback;\n    } else {\n        return value;\n    }\n}\n\nexport function embed(source, node, options) {\n    const theOptions = options || {};\n    const {useShadowDOM = false} = theOptions;\n    const useShadow = useShadowDOM && node.attachShadow;\n    let container;\n    let shadowRoot;\n\n    // The list of nodes that have their dimensions updated\n    // when the notebook container dimensions are supposed to change.\n    // The CloudPlatform code will currently also update the node's dimensions,\n    // but still include it here, just to be sure.\n    const containerNodes = [node];\n\n    const cleanupHandlers = [];\n\n    function onContainerDimensionsChange({width, height}) {\n        containerNodes.forEach(containerNode => {\n            if (width != null) {\n                containerNode.style.width = `${width}px`;\n            }\n            if (height != null) {\n                containerNode.style.height = `${height}px`;\n            }\n        });\n    }\n\n    return Promise.resolve()\n        .then(() => {\n            if (useShadow) {\n                const shadowHost = document.createElement('div');\n                shadowHost.style.width = '100%';\n                shadowHost.style.height = '100%';\n                shadowRoot = shadowHost.attachShadow({mode: 'open'});\n                container = document.createElement('div');\n                container.style.width = '100%';\n                container.style.height = '100%';\n                node.appendChild(shadowHost);\n\n                // Workaround to make React's event handling work,\n                // as suggested in https://github.com/facebook/react/issues/9242#issuecomment-534096832\n                // This makes the shadow root appear like a \"normal document\", so React can use it\n                // for creating elements and registering event handlers.\n                // Otherwise, React event handlers wouldn't fire since events don't bubble up from\n                // the shadow DOM to the top document.\n                Object.defineProperty(container, 'ownerDocument', { value: shadowRoot });\n                shadowRoot.createElement = (...args) => document.createElement(...args);\n                shadowRoot.createElementNS = (...args) => document.createElementNS(...args);\n                shadowRoot.createTextNode = (...args) => document.createTextNode(...args);\n                shadowRoot.createDocumentFragment = (...args) => document.createDocumentFragment(...args);\n\n                // Needed by jQuery, particularly $(...).offset.\n                shadowRoot.documentElement = container;\n                shadowRoot.defaultView = window;\n\n                containerNodes.push(shadowHost);\n                containerNodes.push(container);\n\n                shadowRoot.appendChild(container);\n            } else {\n                container = node;\n            }\n            return getNotebookData(source);\n        })\n        .then(({notebookID, mainScript, otherScripts, stylesheetDomains, notebookExpr, extraData}) => {\n            if (useShadow) {\n                const cleanup = patchShadowStyleInsertion(shadowRoot, stylesheetDomains);\n                cleanupHandlers.push(cleanup);\n                // Move other children from the outer node into the container inside the shadow DOM.\n                // This is important so that a potential HTML cache is picked up by the notebook.\n                for (let i = 0; i < node.children.length - 1; ++i) {\n                    container.appendChild(node.children[i]);\n                }\n            }\n            for (let i = 0; i < otherScripts.length; ++i) {\n                installScript(otherScripts[i]);\n            }\n            return loadLibrary(mainScript).then(lib => [notebookID, lib, notebookExpr, extraData]);\n        })\n        .then(([theNotebookID, lib, notebookExpr, extraData]) => {\n            return lib.embed(theNotebookID, container, {\n                width: defaultValue(theOptions.width, null),\n                maxHeight: defaultValue(theOptions.maxHeight, Infinity),\n                showBorder: defaultValue(theOptions.showBorder, null),\n                allowInteract: defaultValue(theOptions.allowInteract, true),\n                showRenderProgress: defaultValue(theOptions.showRenderProgress, true),\n                // Pass in the original notebook expression string,\n                // even if the CloudPlatform JS code does not currently use it.\n                // (It only relies on the notebookData sent through extraData.)\n                notebookExpr: notebookExpr,\n                extraData: extraData,\n                onContainerDimensionsChange\n            });\n        })\n        .then(embedding => {\n            return {\n                ...embedding,\n                detach: () => {\n                    embedding.detach();\n                    cleanupHandlers.forEach(cleanup => {\n                        cleanup();\n                    });\n                },\n                setAttributes: (attrs) => {\n                    const {width, maxHeight, showBorder, allowInteract, showRenderProgress} = attrs;\n                    embedding.setAttributes({width, maxHeight, showBorder, allowInteract, showRenderProgress});\n                }\n            };\n        });\n}\n\n// As a courtesy, also expose a default export, so consumers of the library can write\n//   import WolframNotebookEmbedder from 'wolfram-notebook-embedder';\n// even though the named-import forms\n//   import * as WolframNotebookEmbedder from 'wolfram-notebook-embedder';\n// or\n//   import {embed} from 'wolfram-notebook-embedder';\n// are preferred.\nexport default {embed};\n"],"names":["installedScripts","libraryLoading","counter","isStyleInsertionPatched","insertedStyles","styleInsertionCallbacks","installScript","url","script","document","createElement","type","src","head","getElementsByTagName","appendChild","loadLibrary","libraryURL","Promise","resolve","reject","onerror","callbackName","window","lib","split","s","separators","before","after","i","length","sep","index","indexOf","substring","isNotebookStyleElement","element","domains","name","tagName","toLowerCase","rel","some","domain","href","startsWith","dataset","isWolframNotebookStyle","innerText","id","patchShadowStyleInsertion","container","callback","allowMove","styleElement","didInsertWithoutCloning","cloneNode","handleStyleElement","push","forEach","cb","existingLinks","existingStyles","originalAppendChild","child","call","existingStyle","splice","getNotebookData","source","cloudBase","params","usePost","notebookExpr","notebookSource","remainingPaths","Error","path","encodeURIComponent","hasPath","hasExpr","expr","hasURL","paramCount","charAt","embeddingAPI","req","XMLHttpRequest","addEventListener","status","text","responseText","data","JSON","parse","extraData","notebookID","mainScript","otherScripts","map","stylesheetDomains","open","setRequestHeader","send","defaultValue","value","fallback","undefined","embed","node","options","theOptions","useShadowDOM","useShadow","attachShadow","shadowRoot","containerNodes","cleanupHandlers","onContainerDimensionsChange","width","height","containerNode","style","then","shadowHost","mode","Object","defineProperty","createElementNS","createTextNode","createDocumentFragment","documentElement","defaultView","cleanup","children","theNotebookID","maxHeight","Infinity","showBorder","allowInteract","showRenderProgress","embedding","detach","setAttributes","attrs"],"mappings":"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"}